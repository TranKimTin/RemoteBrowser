<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Remote Browser</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    canvas {
      border: 1px solid #444;
      cursor: crosshair;
    }
  </style>
</head>

<body>
  <canvas id="screen"></canvas>

  <script>
    const ws = new WebSocket('ws://' + location.host);
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');

    // --- Nhận dữ liệu từ server ---
    ws.onmessage = async e => {
      const data = JSON.parse(e.data);

      // Ảnh màn hình
      if (data.type === 'frame') {
        const img = new Image();
        img.src = 'data:image/jpeg;base64,' + data.image;
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
        };
      }

      // Clipboard từ remote browser
      if (data.type === 'clipboard') {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(data.text);
            console.log('📋 Nhận clipboard từ remote:', data.text);
          } else {
            // Fallback DOM
            const input = document.createElement('textarea');
            input.value = data.text;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            console.log('📋 (Fallback) Nhận clipboard:', data.text);
          }
        } catch (err) {
          console.warn('Không ghi được clipboard, fallback DOM:', err);
          const input = document.createElement('textarea');
          input.value = data.text;
          document.body.appendChild(input);
          input.select();
          document.execCommand('copy');
          document.body.removeChild(input);
          console.log('📋 (Fallback) Nhận clipboard:', data.text);
        }
      }
    };

    // --- Mouse ---
    canvas.addEventListener('mousemove', e => sendMouse('move', e));
    canvas.addEventListener('mousedown', e => sendMouse('down', e));
    canvas.addEventListener('mouseup', e => sendMouse('up', e));
    canvas.addEventListener('wheel', e => {
      ws.send(JSON.stringify({ type: 'mouse', subtype: 'wheel', deltaY: e.deltaY }));
    });

    function sendMouse(subtype, e) {
      ws.send(JSON.stringify({
        type: 'mouse',
        subtype,
        x: e.offsetX,
        y: e.offsetY,
        button: e.button === 2 ? 'right' : 'left'
      }));
    }

    // --- Keyboard ---
    window.addEventListener('keydown', e => {
      ws.send(JSON.stringify({ type: 'key', subtype: 'down', key: e.key }));
      if (e.ctrlKey && e.key === 'v') sendClipboard(); // Ctrl+V để gửi clipboard local
    });

    window.addEventListener('keyup', e => {
      ws.send(JSON.stringify({ type: 'key', subtype: 'up', key: e.key }));
    });

    // --- Clipboard local gửi lên server ---
    async function sendClipboard() {
      try {
        const text = await navigator.clipboard.readText();
        ws.send(JSON.stringify({ type: 'clipboard', text }));
        console.log('📤 Gửi clipboard:', text);
      } catch (err) {
        console.warn('Không đọc được clipboard, fallback DOM:', err);

        // Fallback: dùng textarea + Ctrl+V
        const input = document.createElement('textarea');
        document.body.appendChild(input);
        input.focus();
        document.execCommand('paste');
        const text = input.value;
        document.body.removeChild(input);
        if (text) {
          ws.send(JSON.stringify({ type: 'clipboard', text }));
          console.log('📤 (Fallback) Gửi clipboard:', text);
        }
      }
    }

    // --- Vô hiệu menu chuột phải ---
    window.addEventListener('contextmenu', e => e.preventDefault());
  </script>
</body>

</html>