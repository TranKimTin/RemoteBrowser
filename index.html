<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Remote Browser</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    canvas {
      border: 1px solid #444;
      cursor: crosshair;
    }
  </style>
</head>

<body>
  <canvas id="screen"></canvas>

  <script>
    const ws = new WebSocket('ws://' + location.host);
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');

    ws.onmessage = async e => {
      const data = JSON.parse(e.data);

      // --- Hiển thị frame ---
      if (data.type === 'frame') {
        const img = new Image();
        img.src = 'data:image/jpeg;base64,' + data.image;
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
        };
      }

      // --- Nhận clipboard từ remote ---
      if (data.type === 'clipboard') {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(data.text);
            console.log('📋 Nhận clipboard từ remote:', data.text);
          } else throw new Error('Clipboard API unavailable');
        } catch (err) {
          console.warn('⚠ Không ghi được clipboard, fallback:', err);
          const el = document.createElement('textarea');
          el.value = data.text;
          document.body.appendChild(el);
          el.select();
          document.execCommand('copy');
          document.body.removeChild(el);
          console.log('📋 Fallback copy hoàn tất:', data.text);
        }
      }
    };

    // --- Mouse ---
    canvas.addEventListener('mousemove', e => sendMouse('move', e));
    canvas.addEventListener('mousedown', e => sendMouse('down', e));
    canvas.addEventListener('mouseup', e => sendMouse('up', e));
    canvas.addEventListener('wheel', e => {
      ws.send(JSON.stringify({ type: 'mouse', subtype: 'wheel', deltaY: e.deltaY }));
    });

    function sendMouse(subtype, e) {
      ws.send(JSON.stringify({
        type: 'mouse',
        subtype,
        x: e.offsetX,
        y: e.offsetY,
        button: e.button === 2 ? 'right' : 'left'
      }));
    }

    // --- Keyboard ---
    window.addEventListener('keydown', async e => {
      ws.send(JSON.stringify({ type: 'key', subtype: 'down', key: e.key }));

      // ✅ Khi nhấn Ctrl+V, thử đọc clipboard bằng textarea fallback
      if (e.ctrlKey && e.key.toLowerCase() === 'v') {
        e.preventDefault();
        await readClipboardFallback();
      }
    });

    window.addEventListener('keyup', e => {
      ws.send(JSON.stringify({ type: 'key', subtype: 'up', key: e.key }));
    });

    // --- Đọc clipboard local ---
    async function readClipboardFallback() {
      try {
        // Thử API hiện đại trước
        if (navigator.clipboard?.readText) {
          const text = await navigator.clipboard.readText();
          if (text) {
            ws.send(JSON.stringify({ type: 'clipboard', text }));
            console.log('📤 Gửi clipboard (modern):', text);
            return;
          }
        }
      } catch (_) { }

      // Nếu không được, dùng textarea (yêu cầu Ctrl+V user)
      return new Promise(resolve => {
        const ta = document.createElement('textarea');
        ta.style.position = 'fixed';
        ta.style.opacity = 0;
        document.body.appendChild(ta);
        ta.focus();

        const handlePaste = () => {
          const text = ta.value;
          document.body.removeChild(ta);
          if (text) {
            ws.send(JSON.stringify({ type: 'clipboard', text }));
            console.log('📤 Gửi clipboard (fallback):', text);
          }
          resolve();
        };

        setTimeout(() => {
          handlePaste();
        }, 150); // chờ user Ctrl+V thực thi
      });
    }

    // --- Vô hiệu menu chuột phải ---
    window.addEventListener('contextmenu', e => e.preventDefault());
  </script>
</body>

</html>